# --- Stage 1: Builder ---
FROM node:20-slim AS builder

# Set the working directory inside the container
WORKDIR /app

# Install Python and build tools required for native Node.js modules
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    libudev-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Copy package.json and package-lock.json (or yarn.lock)
COPY package*.json ./

# Install dependencies
RUN npm ci --legacy-peer-deps || \
    npm install --legacy-peer-deps --no-optional || \
    npm install --force

# Copy rest of the project
COPY . .

# Build the Next.js app, skipping linting
# FIX: Added --no-lint to the build command
RUN npm run build -- --no-lint

# -------------------------------
# Production stage
# -------------------------------
FROM node:20-slim AS runner

WORKDIR /app

ENV NODE_ENV=production

# Create a non-root user
RUN groupadd --system --gid 1001 nodejs
RUN useradd --system --uid 1001 nextjs

# Copy only the needed files from builder
COPY --from=builder /app/public ./public
# Ensure you copy the entire .next directory, not just .next/standalone
# Next.js 15+ has a different output structure than older versions
COPY --from=builder /app/.next ./.next 

# If your Next.js app needs a server.js (for custom server or standalone output)
# and it's generated by the build, ensure it's copied.
# If your app runs with 'npm start' which uses 'next start', this might not be needed.
# If your CMD is 'node server.js', then you need to ensure server.js is copied.
# For a standard Next.js app, 'npm start' (which runs 'next start') is common.

# Copy node_modules for runtime
COPY --from=builder /app/node_modules ./node_modules
# Copy package.json for 'npm start'
COPY --from=builder /app/package.json ./package.json


# Change ownership to nextjs user
RUN chown -R nextjs:nodejs /app

USER nextjs

# Expose the port
EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Run the app
# For a standard Next.js app, 'npm start' (which executes 'next start') is typically used.
CMD ["npm", "start"]